version: "3.9"

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: {{ project_name }}-frontend
    ports:
      - "{{ ports.frontend }}:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - {{ project_name }}-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: {{ project_name }}-backend
    ports:
      - "{{ ports.backend }}:{{ ports.backend }}"
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - DATABASE_NAME={{ project_name | replace('-', '_') }}_db
      - REDIS_URL=redis://redis:6379/0
      - PORT={{ ports.backend }}
      - DEBUG=false
      - LOG_LEVEL=info
      - CORS_ORIGINS=http://localhost:{{ ports.frontend }}
{% if auth_required %}
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM={{ project_name }}
      - KEYCLOAK_CLIENT_ID={{ project_name }}-api
{% endif %}
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
{% if auth_required %}
      keycloak:
        condition: service_healthy
{% endif %}
    networks:
      - {{ project_name }}-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{ ports.backend }}/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  mongodb:
    image: mongo:7
    container_name: {{ project_name }}-mongodb
    ports:
      - "{{ ports.mongodb }}:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - {{ project_name }}-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 10s
    command: ["mongod", "--bind_ip_all"]

  redis:
    image: redis:7-alpine
    container_name: {{ project_name }}-redis
    ports:
      - "{{ ports.redis }}:6379"
    volumes:
      - redis_data:/data
    networks:
      - {{ project_name }}-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 5s
{% if auth_required %}

  keycloak:
    build:
      context: ./keycloak
      dockerfile: Dockerfile
    container_name: {{ project_name }}-keycloak
    ports:
      - "{{ ports.keycloak }}:8080"
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://keycloak-postgres:5432/keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak}
      - KC_HOSTNAME_STRICT=false
      - KC_HTTP_ENABLED=true
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    networks:
      - {{ project_name }}-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080; echo -e 'GET /health/ready HTTP/1.1\r\nhost: localhost\r\nConnection: close\r\n\r\n' >&3; cat <&3 | grep -q '200 OK'"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

  keycloak-postgres:
    image: postgres:16-alpine
    container_name: {{ project_name }}-keycloak-postgres
    ports:
      - "{{ ports.keycloak_postgres }}:5432"
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak}
    volumes:
      - keycloak_postgres_data:/var/lib/postgresql/data
    networks:
      - {{ project_name }}-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
{% endif %}

volumes:
  mongodb_data:
    name: {{ project_name }}-mongodb-data
  redis_data:
    name: {{ project_name }}-redis-data
{% if auth_required %}
  keycloak_postgres_data:
    name: {{ project_name }}-keycloak-postgres-data
{% endif %}

networks:
  {{ project_name }}-network:
    name: {{ project_name }}-network
    driver: bridge
